<svg viewBox="0 0 800 1300" xmlns="http://www.w3.org/2000/svg">
  <!-- Styles -->
  <defs>
    <style>
      .box {
        fill: #f0f8ff;
        stroke: #4682b4;
        stroke-width: 2;
        rx: 10;
        ry: 10;
      }
      .specialistBox {
        fill: #e6f2ff;
        stroke: #6495ed;
        stroke-width: 2;
        rx: 10;
        ry: 10;
      }
      .decisionBox {
        fill: #fff0f5;
        stroke: #db7093;
        stroke-width: 2;
        rx: 10;
        ry: 10;
      }
      .arrow {
        stroke: #666;
        stroke-width: 2;
        fill: none;
        marker-end: url(#arrowhead);
      }
      .label {
        font-family: Arial, sans-serif;
        font-size: 14px;
        text-anchor: middle;
        dominant-baseline: middle;
      }
      .smallLabel {
        font-family: Arial, sans-serif;
        font-size: 12px;
        text-anchor: middle;
        fill: #555;
      }
      .subtitle {
        font-family: Arial, sans-serif;
        font-size: 11px;
        text-anchor: middle;
        font-style: italic;
        fill: #666;
      }
      .title {
        font-family: Arial, sans-serif;
        font-size: 24px;
        font-weight: bold;
        text-anchor: middle;
      }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="400" y="30" class="title">Patient Conversation Flow</text>

  <!-- Patient Input -->
  <rect x="325" y="60" width="150" height="50" class="box" />
  <text x="400" y="85" class="label">Patient Input</text>

  <!-- API Gateway -->
  <rect x="325" y="150" width="150" height="50" class="box" />
  <text x="400" y="175" class="label">API Gateway</text>

  <!-- Classifier Service -->
  <rect x="325" y="240" width="150" height="50" class="box" />
  <text x="400" y="255" class="label">Classifier Service</text>
  <text x="400" y="275" class="subtitle">(Medical / Non-Medical)</text>

  <!-- Non-Medical Branch -->
  <rect x="150" y="330" width="150" height="50" class="decisionBox" />
  <text x="225" y="345" class="label">Non-Medical</text>
  <text x="225" y="365" class="subtitle">(Reply &amp; Exit)</text>

  <!-- Medical Query Branch -->
  <rect x="500" y="330" width="150" height="50" class="decisionBox" />
  <text x="575" y="355" class="label">Medical Query</text>

  <!-- Conversation Orchestrator -->
  <rect x="500" y="420" width="150" height="50" class="box" />
  <text x="575" y="445" class="label">Conversation Orchestrator</text>

  <!-- New Conversation -->
  <rect x="325" y="510" width="150" height="50" class="decisionBox" />
  <text x="400" y="525" class="label">New Conversation</text>
  <text x="400" y="545" class="subtitle">(First Time)</text>

  <!-- Existing Conversation -->
  <rect x="675" y="510" width="150" height="50" class="decisionBox" />
  <text x="750" y="525" class="label">Existing Conversation</text>
  <text x="750" y="545" class="subtitle">(Resume from memory)</text>

  <!-- Checkpoint Generator -->
  <rect x="325" y="600" width="150" height="50" class="box" />
  <text x="400" y="615" class="label">Checkpoint Generator</text>
  <text x="400" y="635" class="subtitle">(Create Key Questions)</text>

  <!-- Memory Loader -->
  <rect x="675" y="600" width="150" height="50" class="box" />
  <text x="750" y="615" class="label">Memory Loader</text>
  <text x="750" y="635" class="subtitle">(Fetch Context)</text>

  <!-- Checkpoint Conversation Loop -->
  <rect x="325" y="700" width="350" height="50" class="box" />
  <text x="500" y="715" class="label">Checkpoint Conversation Loop</text>
  <text x="500" y="735" class="subtitle">(Sequentially ask questions)</text>

  <!-- Specialist Agents Box -->
  <rect x="225" y="790" width="550" height="140" class="specialistBox" />
  <text x="500" y="810" class="label">Specialist Agents</text>
  <text x="500" y="830" class="subtitle">(Called when needed)</text>

  <!-- Specialist sub-boxes -->
  <rect x="250" y="840" width="240" height="30" fill="#d1e7ff" stroke="#6495ed" rx="5" ry="5" />
  <text x="370" y="860" class="smallLabel">Nutrition Agent (Diet advice)</text>

  <rect x="250" y="875" width="240" height="30" fill="#d1e7ff" stroke="#6495ed" rx="5" ry="5" />
  <text x="370" y="895" class="smallLabel">Checklist Agent (Track task done)</text>

  <rect x="510" y="840" width="240" height="30" fill="#d1e7ff" stroke="#6495ed" rx="5" ry="5" />
  <text x="630" y="860" class="smallLabel">Human Intervention (Escalate risk)</text>

  <rect x="510" y="875" width="240" height="30" fill="#d1e7ff" stroke="#6495ed" rx="5" ry="5" />
  <text x="630" y="895" class="smallLabel">Medication Agent (Medicine check)</text>

  <!-- Update Memory Context -->
  <rect x="325" y="970" width="350" height="50" class="box" />
  <text x="500" y="985" class="label">Update Memory Context</text>
  <text x="500" y="1005" class="subtitle">(Redis → Short-term, MongoDB/Pinecone → Long-term)</text>

  <!-- Final Summarizer Agent -->
  <rect x="325" y="1060" width="350" height="50" class="box" />
  <text x="500" y="1075" class="label">Final Summarizer Agent</text>
  <text x="500" y="1095" class="subtitle">(Prepare final coherent response to patient)</text>

  <!-- Send Reply to Patient -->
  <rect x="325" y="1150" width="350" height="40" class="box" />
  <text x="500" y="1170" class="label">Send Reply to Patient</text>

  <!-- Normal End -->
  <rect x="150" y="1230" width="200" height="40" class="decisionBox" />
  <text x="250" y="1250" class="label">Normal End of Conversation</text>

  <!-- Human Escalation -->
  <rect x="650" y="1230" width="200" height="40" class="decisionBox" />
  <text x="750" y="1250" class="label">Human Escalation Triggered</text>
  <text x="750" y="1270" class="subtitle">(Manual intervention)</text>

  <!-- Connection Lines -->
  <!-- Patient Input to API Gateway -->
  <path d="M 400 110 L 400 150" class="arrow" />

  <!-- API Gateway to Classifier Service -->
  <path d="M 400 200 L 400 240" class="arrow" />

  <!-- Classifier Service branch -->
  <path d="M 400 290 L 400 310 L 225 310 L 225 330" class="arrow" />
  <path d="M 400 290 L 400 310 L 575 310 L 575 330" class="arrow" />

  <!-- Medical Query to Conversation Orchestrator -->
  <path d="M 575 380 L 575 420" class="arrow" />

  <!-- Conversation Orchestrator branch -->
  <path d="M 575 470 L 575 490 L 400 490 L 400 510" class="arrow" />
  <path d="M 575 470 L 575 490 L 750 490 L 750 510" class="arrow" />

  <!-- New Conversation to Checkpoint Generator -->
  <path d="M 400 560 L 400 600" class="arrow" />

  <!-- Existing Conversation to Memory Loader -->
  <path d="M 750 560 L 750 600" class="arrow" />

  <!-- Both paths to Checkpoint Conversation Loop -->
  <path d="M 400 650 L 400 675 L 500 675 L 500 700" class="arrow" />
  <path d="M 750 650 L 750 675 L 500 675 L 500 700" class="arrow" />

  <!-- Checkpoint Conversation Loop to Specialist Agents -->
  <path d="M 500 750 L 500 790" class="arrow" />

  <!-- Specialist Agents to Update Memory Context -->
  <path d="M 500 930 L 500 970" class="arrow" />

  <!-- Update Memory Context to Final Summarizer Agent -->
  <path d="M 500 1020 L 500 1060" class="arrow" />

  <!-- Final Summarizer Agent to Send Reply to Patient -->
  <path d="M 500 1110 L 500 1150" class="arrow" />

  <!-- Send Reply to Patient branch -->
  <path d="M 500 1190 L 500 1210 L 250 1210 L 250 1230" class="arrow" />
  <path d="M 500 1190 L 500 1210 L 750 1210 L 750 1230" class="arrow" />
</svg>
